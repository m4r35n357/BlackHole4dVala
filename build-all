#!/bin/sh

opt="${1:-fast}"

valac="valac -v --save-temps -X -O$opt -X -lm"
valac --version
which valac

symplectics='nbody3d newton'

# cleanup
rm -f $outfile $symplectics TestKdS KdS bh3dRk4 raytrace-commands kerr-image icgenParticle icgenLight
echo ""

# compile vala files
for executable in $symplectics
do
	rm -f ${executable}.c
	$valac --pkg json-glib-1.0 $executable.vala symplectic.vala utils.vala
	echo ""
done

$valac --pkg json-glib-1.0 TestKdS.vala KdSBase.vala bh3dRk4.vala bh3dSymp.vala symplectic.vala utils.vala
echo ""

$valac --pkg json-glib-1.0 KdS.vala KdSBase.vala bh3dRk4.vala bh3dSymp.vala symplectic.vala utils.vala
echo ""

$valac --pkg json-glib-1.0 raytrace-commands.vala
echo ""

gcc -o kerr-image kerr-image.c -O$opt -Wall -std=c99 -pedantic -Wextra -Wno-unused-result -lm
gcc -o kerr-image-ian kerr-image-ian.c -O$opt -Wall -std=c99 -pedantic -Wextra -Wno-unused-result -lm
echo ""

$valac -q -X -w --pkg json-glib-1.0 --pkg gsl icgenParticle.vala utils.vala
echo ""

$valac -q -X -w --pkg json-glib-1.0 icgenLight.vala utils.vala
echo ""

# strip symplectics
case $opt in
	fast)	strip $symplectics KdS raytrace-commands kerr-image kerr-image-ian icgenParticle icgenLight;;
esac

# admire our work
ls -lAh --color $symplectics TestKdS KdS raytrace-commands kerr-image kerr-image-ian icgenParticle icgenLight

# test
./TestKdS >/dev/null && echo OK

